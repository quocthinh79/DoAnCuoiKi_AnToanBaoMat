 # TẠO DATABASE
CREATE DATABASE WEBBANHANG;
USE WEBBANHANG;
ALTER DATABASE WEBBANHANG CHARACTER SET utf8 COLLATE utf8_unicode_ci;
CREATE TABLE SANPHAM(
	MA_SP VARCHAR(10) PRIMARY KEY NOT NULL,
    TEN_SP VARCHAR(255) NOT NULL,
    MA_NHAN_HIEU VARCHAR(10) NOT NULL,
    GIA DOUBLE NOT NULL,
    MO_TA TEXT,
    HINH_NHO VARCHAR(255),
    NGUOI_THEM VARCHAR(255),
    NGAY_THEM DATETIME DEFAULT CURRENT_TIMESTAMP,
    TONG_DANH_GIA INTEGER DEFAULT 0,
    TONG_SAO INTEGER DEFAULT 0,
    SO_LUONG INTEGER DEFAULT 0
);

CREATE TABLE NHANHIEU(
	MA_NHAN_HIEU VARCHAR(10) PRIMARY KEY NOT NULL,
    TEN_NHAN_HIEU VARCHAR(255) NOT NULL,
    NGAY_CAP_NHAT DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE THE(
	MA_SP VARCHAR(10) NOT NULL,
	MA_CT_THE VARCHAR(10) NOT NULL
);

CREATE TABLE CHITIETTHE(
	MA_CT_THE VARCHAR(10) PRIMARY KEY NOT NULL,
    TEN_THE VARCHAR(255) NOT NULL,
    MA_NHAN_HIEU VARCHAR(10),
    NGUOI_THEM VARCHAR(255),
    NGAY_THEM DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE KICHTHUOC(
	MA_SP VARCHAR(10) NOT NULL,
	MA_CT_KICH_THUOC VARCHAR(10) NOT NULL
);

CREATE TABLE CHITIETKICHTHUOC(
	MA_CT_KICH_THUOC VARCHAR(10) PRIMARY KEY NOT NULL,
    TEN_KICH_THUOC VARCHAR(255) NOT NULL,
    NGUOI_THEM VARCHAR(255),
    NGAY_THEM DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE MAU(
	MA_SP VARCHAR(10) NOT NULL,
	MA_CT_MAU VARCHAR(10) NOT NULL
);

CREATE TABLE CHITIETMAU(
	MA_CT_MAU VARCHAR(10) PRIMARY KEY NOT NULL,
    TEN_MAU VARCHAR(255) NOT NULL,
    NGUOI_THEM VARCHAR(255),
    NGAY_THEM DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE HINHANH(
	MA_SP VARCHAR(10) NOT NULL,
    MA_CT_MAU VARCHAR(10) NOT NULL,
    DUONG_DAN_ANH VARCHAR(255)
);

CREATE TABLE TAIKHOAN (
    MA_TK INTEGER PRIMARY KEY AUTO_INCREMENT,
    HO VARCHAR(255) NOT NULL,
    TEN VARCHAR(255) NOT NULL,
    SDT VARCHAR(20) NOT NULL,
    EMAIL VARCHAR(50) NOT NULL,
    DIA_CHI VARCHAR(100),
    TEN_TK VARCHAR(50) NOT NULL,
    MAT_KHAU VARCHAR(50) NOT NULL,
    NGAY_DK DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    MA_VAI_TRO VARCHAR(10) NOT NULL DEFAULT 'VT2'
); 

CREATE TABLE DANGKY (
    MA_DK INTEGER PRIMARY KEY AUTO_INCREMENT,
    MA_XAC_THUC VARCHAR(255) NOT NULL,
    HO VARCHAR(255) NOT NULL,
    TEN VARCHAR(255) NOT NULL,
    SDT VARCHAR(20) NOT NULL,
    EMAIL VARCHAR(50) NOT NULL,
    TEN_TK VARCHAR(50) NOT NULL,
    MAT_KHAU VARCHAR(50) NOT NULL,
    NGAY_DK DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    TRANG_THAI VARCHAR(20) NOT NULL DEFAULT 'DANG_CHO'
); 

CREATE TABLE VAITRO (
    MA_VAI_TRO VARCHAR(10) PRIMARY KEY,
    TEN_VAI_TRO VARCHAR(50) NOT NULL,
    NGAY_THEM DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    NGAY_CAP_NHAT DATETIME
); 

CREATE TABLE HOADON (
    MA_HOA_DON INTEGER PRIMARY KEY AUTO_INCREMENT,
    MA_GIO INTEGER NOT NULL,
    DIA_CHI_GH VARCHAR(255) NOT NULL,
    SDT VARCHAR(20) NOT NULL,
    NGUOI_NHAN VARCHAR(255) NOT NULL,
    NGAY_THEM DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    THANH_TIEN DOUBLE NOT NULL,
    TRANG_THAI VARCHAR(255) NOT NULL
);


CREATE TABLE CTHD (
    MA_HOA_DON INTEGER NOT NULL,
    MA_SP VARCHAR(10) NOT NULL,
    KICH_THUOC VARCHAR(10) NOT NULL,
    MAU_SAC VARCHAR(10) NOT NULL,
    SO_LUONG INTEGER NOT NULL
); 

CREATE TABLE GIO (
    MA_GIO INTEGER PRIMARY KEY AUTO_INCREMENT,
    MA_TK INTEGER,
    NGAY_THEM DATETIME NOT NULL  DEFAULT CURRENT_TIMESTAMP,
    NGAY_CAP_NHAT DATETIME
); 

CREATE TABLE CHITIETGIO (
    MA_GIO INTEGER NOT NULL,
    MA_SP VARCHAR(10) NOT NULL,
    KICH_THUOC VARCHAR(10) NOT NULL,
    MAUSAC VARCHAR(10) NOT NULL,
    SO_LUONG INT NOT NULL,
    NGAY_THEM DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    NGAY_CAP_NHAT DATETIME
); 

CREATE TABLE QUENMATKHAU (
    MA_DINH_DANH INTEGER PRIMARY KEY AUTO_INCREMENT,
    EMAIL VARCHAR(50) NOT NULL,
    NGAY_LAY_LAI DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
); 

CREATE TABLE CHITIETDANHGIA (
    MA_CT_DANH_GIA INTEGER PRIMARY KEY AUTO_INCREMENT,
    BINH_LUAN VARCHAR(255),
   DANH_GIA INTEGER NOT NULL
); 

CREATE TABLE DANHGIA (
   MA_SP VARCHAR(10) NOT NULL,
   MA_TK INTEGER NOT NULL,
   MA_CT_DANH_GIA INTEGER NOT NULL
);

CREATE TABLE PHIEUNHAP(
	MA_PHIEU_NHAP VARCHAR(10) PRIMARY KEY,
    NGUOI_NHAP VARCHAR(255),
    NGAY_NHAP DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE CTPHIEUNHAP(
    MA_PHIEU_NHAP VARCHAR(10) PRIMARY KEY,
    MA_SP VARCHAR(10) NOT NULL,
    SO_LUONG_NHAP INTEGER DEFAULT 0,
    GIA_NHAP DOUBLE
);

-- THEM KHOA NGOAI --
ALTER TABLE SANPHAM ADD CONSTRAINT FK_SP_NHANHIEU FOREIGN KEY (MA_NHAN_HIEU) REFERENCES NHANHIEU(MA_NHAN_HIEU);

ALTER TABLE THE ADD CONSTRAINT FK_THE_SP FOREIGN KEY (MA_SP) REFERENCES SANPHAM(MA_SP);
ALTER TABLE THE ADD CONSTRAINT FK_THE_CTTHE FOREIGN KEY (MA_CT_THE) REFERENCES CHITIETTHE(MA_CT_THE);

ALTER TABLE KICHTHUOC ADD CONSTRAINT FK_KT_SP FOREIGN KEY (MA_SP) REFERENCES SANPHAM(MA_SP);
ALTER TABLE KICHTHUOC ADD CONSTRAINT FK_KT_CTKICHTHUOC FOREIGN KEY (MA_CT_KICH_THUOC) REFERENCES CHITIETKICHTHUOC(MA_CT_KICH_THUOC);

ALTER TABLE MAU ADD CONSTRAINT FK_MAU_SP FOREIGN KEY (MA_SP) REFERENCES SANPHAM(MA_SP);
ALTER TABLE MAU ADD CONSTRAINT FK_MAU_CTMAU FOREIGN KEY (MA_CT_MAU) REFERENCES CHITIETMAU(MA_CT_MAU);

ALTER TABLE HINHANH ADD CONSTRAINT FK_HINHANH_SP FOREIGN KEY (MA_SP) REFERENCES SANPHAM(MA_SP);
ALTER TABLE HINHANH ADD CONSTRAINT FK_HINHANH_CTMAU FOREIGN KEY (MA_CT_MAU) REFERENCES CHITIETMAU(MA_CT_MAU);

ALTER TABLE CHITIETGIO ADD CONSTRAINT FK_CTGIO_SP FOREIGN KEY (MA_SP) REFERENCES SANPHAM(MA_SP);
ALTER TABLE CHITIETGIO ADD CONSTRAINT FK_CTGIO_GIO FOREIGN KEY (MA_GIO) REFERENCES GIO(MA_GIO);

ALTER TABLE CTHD ADD CONSTRAINT FK_CTHD_SP FOREIGN KEY (MA_SP) REFERENCES SANPHAM(MA_SP);
ALTER TABLE CTHD ADD CONSTRAINT FK_CTHD_HD FOREIGN KEY (MA_HOA_DON) REFERENCES HOADON(MA_HOA_DON);

ALTER TABLE DANHGIA ADD CONSTRAINT FK_DANHGIA_SP FOREIGN KEY (MA_SP) REFERENCES SANPHAM(MA_SP);
ALTER TABLE DANHGIA ADD CONSTRAINT FK_DANHGIA_TK FOREIGN KEY (MA_TK) REFERENCES TAIKHOAN(MA_TK);
ALTER TABLE DANHGIA ADD CONSTRAINT FK_DANHGIA_CTDANHGIA FOREIGN KEY (MA_CT_DANH_GIA) REFERENCES CHITIETDANHGIA(MA_CT_DANH_GIA);

ALTER TABLE TAIKHOAN ADD CONSTRAINT FK_TK_VAITRO FOREIGN KEY (MA_VAI_TRO) REFERENCES VAITRO(MA_VAI_TRO);

ALTER TABLE CTPHIEUNHAP ADD CONSTRAINT FK_CTPN_PN FOREIGN KEY (MA_PHIEU_NHAP) REFERENCES PHIEUNHAP(MA_PHIEU_NHAP);
ALTER TABLE CTPHIEUNHAP ADD CONSTRAINT FK_CTPN_SP FOREIGN KEY (MA_SP) REFERENCES SANPHAM(MA_SP);

ALTER TABLE GIO ADD CONSTRAINT FK_GIO_TK FOREIGN KEY (MA_TK) REFERENCES TAIKHOAN(MA_TK);
-- ============ --

-- THEM KHOA DUY NHAT --
ALTER TABLE THE ADD CONSTRAINT UK_THE UNIQUE (MA_SP, MA_CT_THE);
ALTER TABLE KICHTHUOC ADD CONSTRAINT UK_KICHTHUOC UNIQUE (MA_SP, MA_CT_KICH_THUOC);
ALTER TABLE MAU ADD CONSTRAINT UK_MAU UNIQUE (MA_SP, MA_CT_MAU);
ALTER TABLE HINHANH ADD CONSTRAINT UK_HINHANH UNIQUE (MA_SP, MA_CT_MAU, DUONG_DAN_ANH);
ALTER TABLE DANHGIA ADD CONSTRAINT UK_DANHGIA UNIQUE (MA_SP, MA_TK, MA_CT_DANH_GIA);
ALTER TABLE CHITIETGIO ADD CONSTRAINT UK_CTGIO UNIQUE (MA_GIO, MA_SP);
ALTER TABLE CTHD ADD CONSTRAINT UK_CTHD UNIQUE (MA_HOA_DON, MA_SP);

#TRIGGER TẠO GIỎ KHI TK ĐƯỢC TẠO
CREATE TRIGGER TAO_GIO_CHO_TK AFTER INSERT ON TAIKHOAN
FOR EACH ROW
INSERT INTO GIO(MA_TK) VALUES(NEW.MA_TK);

#TRIGGER MỞ TK KHI XÁC THỰC ĐK
DELIMITER $$ 
CREATE TRIGGER tao_TK_Khi_DK_Thanh_Cong AFTER UPDATE ON DANGKY FOR EACH ROW
BEGIN
IF (NEW.TRANG_THAI =  'THANH_CONG') 
THEN
INSERT INTO TAIKHOAN(HO, TEN, SDT, EMAIL, TEN_TK, MAT_KHAU) 
SELECT HO, TEN, SDT, EMAIL, TEN_TK, MAT_KHAU FROM DANGKY WHERE MA_DK = NEW.MA_DK AND MA_XAC_THUC = NEW.MA_XAC_THUC;
END IF; 
END $$
DELIMITER ;

#PROCEDURE LẤY THÔNG TIN TK
CREATE PROCEDURE layTaiKhoan (IN ten_TK VARCHAR(50), IN mat_Khau VARCHAR(50))
SELECT tk.MA_TK, tk.HO, tk.TEN, tk.SDT, tk.EMAIL, tk.DIA_CHI, tk.TEN_TK, tk.MAT_KHAU, tk.NGAY_DK, vt.TEN_VAI_TRO 
FROM TAIKHOAN AS tk, VAITRO AS vt
WHERE tk.TEN_TK = ten_TK AND tk.MAT_KHAU = mat_Khau AND tk.MA_VAI_TRO = vt.MA_VAI_TRO;

#PROCEDURE THEM DANG KY MOI
CREATE PROCEDURE themDangKy (IN MA_XAC_THUC VARCHAR(255), IN HO VARCHAR(255), IN TEN VARCHAR(255),IN SDT VARCHAR(20), EMAIL VARCHAR(50), IN TEN_TK VARCHAR(50), IN MAT_KHAU VARCHAR(50))
INSERT INTO DANGKY(MA_XAC_THUC, HO, TEN, SDT, EMAIL, TEN_TK, MAT_KHAU) VALUES(MA_XAC_THUC, HO, TEN, SDT, EMAIL, TEN_TK, MAT_KHAU);

#PROCEDURE lấy thông tin sản phẩm
DELIMITER $$
CREATE PROCEDURE layDanhSachSanPham ()
BEGIN
SELECT sp.MA_SP, sp.TEN_SP, nh.TEN_NHAN_HIEU, sp.GIA, sp.MO_TA, sp.HINH_NHO, sp.NGAY_THEM,  sp.TONG_DANH_GIA, sp.TONG_SAO, sp.SO_LUONG FROM SANPHAM AS sp, NHANHIEU AS nh WHERE sp.MA_NHAN_HIEU = nh.MA_NHAN_HIEU;
END $$
DELIMITER ;

#PROCEDURE lấy sản phẩm từ mã sản phẩm
DELIMITER $$
CREATE PROCEDURE laySanPham(IN MA_SP VARCHAR(10))
BEGIN
SELECT sp.MA_SP, sp.TEN_SP, nh.TEN_NHAN_HIEU, sp.GIA, sp.MO_TA, sp.HINH_NHO, sp.NGAY_THEM,  sp.TONG_DANH_GIA, sp.TONG_SAO, sp.SO_LUONG FROM SANPHAM AS sp, NHANHIEU AS nh WHERE sp.MA_SP = MA_SP AND sp.MA_NHAN_HIEU = nh.MA_NHAN_HIEU;
END $$
DELIMITER ;

#PROCEDURE lấy giới hạn sản phẩm
DELIMITER $$
CREATE PROCEDURE layCacSanPham(IN VI_TRI INT, IN SO_LUONG INT)
BEGIN
SELECT sp.MA_SP, sp.TEN_SP, nh.TEN_NHAN_HIEU, sp.GIA, sp.MO_TA, sp.HINH_NHO, sp.NGAY_THEM,  sp.TONG_DANH_GIA, sp.TONG_SAO, sp.SO_LUONG FROM SANPHAM AS sp, NHANHIEU AS nh WHERE sp.MA_NHAN_HIEU = nh.MA_NHAN_HIEU LIMIT VI_TRI, SO_LUONG;
END $$
DELIMITER ;


#PROCEDURE lấy màu của sản phẩm
DELIMITER $$
CREATE PROCEDURE layDSMau(IN MA_SP VARCHAR(10))
BEGIN
SELECT ctm.TEN_MAU FROM MAU AS m, CHITIETMAU AS ctm WHERE m.MA_SP = MA_SP AND m.MA_CT_MAU = ctm.MA_CT_MAU;
END $$
DELIMITER ;

#PROCEDURE lấy kích thước của sản phẩm
DELIMITER $$
CREATE PROCEDURE layDSKichThuoc(IN MA_SP VARCHAR(10))
BEGIN
SELECT ctkt.TEN_KICH_THUOC FROM KICHTHUOC AS kt, CHITIETKICHTHUOC AS ctkt WHERE kt.MA_SP = MA_SP AND kt.MA_CT_KICH_THUOC = ctkt.MA_CT_KICH_THUOC;
END $$
DELIMITER ;

#PROCEDURE lấy thẻ của sản phẩm
DELIMITER $$
CREATE PROCEDURE layDSThe(IN MA_SP VARCHAR(10))
BEGIN
SELECT ctt.TEN_THE FROM THE AS t, CHITIETTHE AS ctt WHERE t.MA_SP = MA_SP AND t.MA_CT_THE = ctt.MA_CT_THE;
END $$
DELIMITER ;

#PROCEDURE lấy hình của sản phẩm
DELIMITER $$
CREATE PROCEDURE layDSHinh(IN MA_SP VARCHAR(10))
BEGIN
SELECT ha.DUONG_DAN_ANH FROM HINHANH AS ha WHERE ha.MA_SP = MA_SP;
END $$
DELIMITER ;
#PROCEDURE get all item cart
DELIMITER $$
CREATE PROCEDURE getAllItemCart(in MA_GIO integer )
BEGIN
SELECT sp.HINH_NHO, c.KICH_THUOC, c.MAUSAC, c.SO_LUONG, c.MA_SP, sp.TEN_SP, sp.GIA FROM SANPHAM AS sp, CHITIETGIO AS c WHERE
 c.MA_SP=sp.MA_SP AND c.MA_GIO=MA_GIO;
END $$
DELIMITER ;